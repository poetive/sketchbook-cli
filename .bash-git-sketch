#!/bin/bash

# Info
# 1. Close Sketch files before pushing or pulling changes
# 2. Following scripts are useful for an individual, not a team workflow

# Scenarios
# 1. Create git repository online and clone
# 2. Create git repository locally and add remote origin
# 3. Create git repository locally and create remote repository

# To do
# 1. Test adding sketch file from subfolder
# 2. Fix extractSketchFiles script to iterate over directories
# 3. Test gitlfs on git-sketch-init

# Simplify git commands
# new
# link
# push
# - add files
# - add commit message
# pull




extractSketchFiles() {
    echo 'Extracting Sketch file(s)...'
    root="${PWD}"
    sketchFiles=()
    while IFS= read -r -d $'\0'; do
        sketchFiles+=("$REPLY")
    done < <(find . -type f -name "*.sketch" -print0)
    for file in $sketchFiles; do
        directory=$(dirname "${file}")
        filename=$(echo $file | awk -F/ '{print $NF}' | sed -e 's/.sketch$//')
        cd $directory
        command unzip -q -o $filename'.sketch' -d $filename'--sketch'
        for file in $(find . -name '*.json'); do
            python -m json.tool $file > tmp.$$.json
            mv tmp.$$.json $file
        done
        echo "→" $filename'.sketch'
        cd $root
    done
}

buildSketchFiles() {
    echo 'Building Sketch file(s)...'
    root="${PWD}"
    sketchDirectories=()
    while IFS= read -r -d $'\0'; do
        sketchDirectories+=("$REPLY")
    done < <(find . -type d -name "*--sketch" -print0)
    for directory in $sketchDirectories; do
        cd $directory
        sketchFile=$(echo $directory | awk -F/ '{print $NF}' | sed -e 's/--sketch$//').sketch
        zip -q -r -X $sketchFile *
        mv $sketchFile ../
        echo "→" $sketchFile
        cd $root
    done
}

# git-sketch-new() {
    # combine git sketch init with adding/creating remote repo and initial push
    # https://stackoverflow.com/questions/2423777/is-it-possible-to-create-a-remote-repo-on-github-from-the-cli-without-opening-br
# }

git-sketch-init() {
    git init
    touch .gitignore
    echo 'previews/' >> .gitignore
    echo '.sketch' >> .gitignore
    touch .gitattributes
    echo '*.png filter=lfs diff=lfs merge=lfs -text' >> .gitattributes
    echo '*.jpg filter=lfs diff=lfs merge=lfs -text' >> .gitattributes
    echo '*.gif filter=lfs diff=lfs merge=lfs -text' >> .gitattributes
    extractSketchFiles
}

git-sketch-origin() {
    origin=$1
    git remote add origin $origin
}

git-sketch-clone() {
    url=$1
    git clone $url
    projectName=$(echo $url | awk -F/ '{print $NF}' | sed -e 's/.git$//')
    cd $projectName
    buildSketchFiles
}

git-sketch-pull() {
    git pull
    buildSketchFiles
}

git-sketch-add() {
    sketchFile=${1/.sketch}
    command unzip -q -o $sketchFile.sketch -d $sketchFile'--sketch'
    for file in $(find . -maxdepth 1 -name '*.json'); do
        python -m json.tool $file > tmp.$$.json
        mv tmp.$$.json $file
    done
    git add $sketchFile'--sketch'/*
}

git-sketch-commit() {
    message=$1
    git commit -m $message
}

git-sketch-push() {
    git push
}
